<?xml version="1.0" encoding="UTF-8"?>
<project name="misc">

	<target name="help" description="Displays project's help">
		<java classname="org.apache.tools.ant.Main">
			<arg value="-buildfile" />
			<arg value="${ant.file}" />
			<arg value="-projecthelp" />
		</java>
	</target>

	<!-- This target depends on several targets to make sure that one does not send a wrongly configured project to some env -->
	<target name="sync" description="(R)Sync your project files to a remote destination" depends="setprofile">
		<echo>Rsyncing to ${remote.username}@${remote.host}:${remote.path.root}</echo>
		<exec executable="rsync">
			<arg line="--cvs-exclude 
              --exclude-from=${basedir}/etc/common/rsync.exclude
              --links
	      ${rsync.options}
              -agpvzc src/ -e ssh ${remote.username}@${remote.host}:${remote.path.root}" />
		</exec>
	</target>
	
	<target name="deploy" description="Deploys latest changes to environment defined by profile" depends="configure,build,liquibase.migrate,sync">
	</target>
	
	<target name="build" description="Builds project (ORM classes generation, etc)" depends="symfony.orm">
	</target>

	<target name="init" description="Sets up project for usage with the toolkit">
		<fail unless="profile" />
		<fail unless="toolkitDir" />

		<!-- Create directories -->
		<mkdir dir="${basedir}/src" />
		<mkdir dir="${basedir}/etc/liquibase/changelogs/" />
		
		<!-- Create common configuration profile -->
		<copy todir="${basedir}/etc/common">
			<fileset dir="${toolkitDir}/templates/profile/" includes="**/*" />
		</copy>

		<!-- Create local configuration profile -->
		<antcall target="init.properties" />
		
		<!-- Create project build.xml file -->
		<copy todir="${basedir}" file="${toolkitDir}/templates/build.xml" />
	</target>

	<target name="init.properties" description="Creates a new property file for configuration profile">
		<fail unless="profile" />
		
		<!-- Create profile directory -->
		<mkdir dir="${basedir}/etc/${profile}" />

		<!-- Backup existing build.properties file -->
		<copy file="${basedir}/etc/${profile}/build.properties" tofile="${basedir}/etc/${profile}/build.properties.bak" />
		<echo>Backuped existing property file to ${basedir}/etc/${profile}/build.properties.bak</echo>

		<!-- Generate initial build.properties file from project sources -->
		<exec executable="${toolkitDir}/vendor/phpreprocessor/bin/phpreprocessor" output="${basedir}/etc/${profile}/build.properties" logError="true">
			<arg line="--command=extract --exclude-from=${toolkitDir}/etc/default/build.properties,${basedir}/etc/common/build.properties --src=${basedir}/src" />
		</exec>
		<echo>Extracted tokens from project sources into ${basedir}/etc/${profile}/build.properties</echo>
	</target>
</project>
