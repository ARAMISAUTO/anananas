<?xml version="1.0" encoding="UTF-8"?>
<project name="toolkit" default="help">
	<!-- Store toolkit base directory for later use -->
	<dirname property="toolkit.basedir" file="${ant.file.toolkit}/../.." />

	<!-- Enable ant-contrib (@see http://ant-contrib.sourceforge.net) -->
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="${toolkit.basedir}/vendor/ant-contrib/ant-contrib-1.0b3.jar" />
		</classpath>
	</taskdef>

	<target name="help" description="Displays project's help">
		<echo>Ananas Build Toolkit : Usage</echo>
		<java classname="org.apache.tools.ant.Main">
			<arg value="-buildfile" />
			<arg value="${ant.file}" />
			<arg value="-projecthelp" />
		</java>
		<echo>More documentation can obtained at https://github.com/contructions-incongrues/ananas-build-toolkit</echo>
	</target>

	<target name="setprofile">
		<!-- Guess profile -->
		<exec outputproperty="profile" logError="true" executable="whoami" />
		<echo message="Using profile : ${profile}" />

		<!-- Local configuration profile properties -->
		<property file="etc/${profile}/build.properties" />

		<!-- Team common properties -->
		<property file="etc/common/build.properties" />
	</target>

	<target name="toolkit.init" description="Sets up project for usage with the toolkit">
		<fail unless="profile" />

		<!-- Create directories -->
		<mkdir dir="${basedir}/src" />
		<mkdir dir="${basedir}/etc/liquibase/changelogs/" />
		
		<!-- Create common configuration profile -->
		<mkdir dir="${basedir}/etc/common" />
		<copy file="${toolkit.basedir}/templates/profile/build.properties" todir="${basedir}/etc/common" overwrite="false" />
		<copy file="${toolkit.basedir}/templates/profile/rsync.exclude" todir="${basedir}/etc/common" overwrite="false" />

		<!-- Create local configuration profile -->
		<antcall target="init.properties" />
		
		<!-- Create project build.xml file -->
		<copy todir="${basedir}" file="${toolkit.basedir}/templates/build.xml" />
	</target>

	<target name="init.properties" description="Creates a new property file for configuration profile">
		<fail unless="profile" />
		
		<!-- Create profile directory and property file if it does not exist -->
		<touch file="${basedir}/etc/${profile}/build.properties" mkdirs="true" />

		<!-- Backup existing build.properties file -->
		<copy file="${basedir}/etc/${profile}/build.properties" tofile="${basedir}/etc/${profile}/build.properties.bak" failonerror="false" />
		<echo>Backuped existing property file to ${basedir}/etc/${profile}/build.properties.bak</echo>

		<!-- Generate initial build.properties file from project sources -->
		<exec executable="${toolkit.basedir}/vendor/phpreprocessor/bin/phpreprocessor" output="${basedir}/etc/${profile}/build.properties" logError="true">
			<arg line="--command=extract --exclude-from=${toolkit.basedir}/etc/default/build.properties,${basedir}/etc/common/build.properties --src=${basedir}/src --merge-with=${basedir}/etc/${profile}/build.properties" />
		</exec>
		<echo>Extracted tokens from project sources into ${basedir}/etc/${profile}/build.properties</echo>
	</target>

	<!-- Import default modules -->
	<import file="${toolkit.basedir}/modules/configure/module.xml" />
	<import file="${toolkit.basedir}/modules/rsync/module.xml" />
</project>
