<?xml version="1.0" encoding="UTF-8"?>
<project name="properties" default="help">
	<!-- Mandatory targets -->
	<target name="init" />
	<target name="install" />
	<target name="build" />
	<target name="package" />
	<target name="upload" />
	<target name="configure" />

	<!-- Preprocesses -dist files -->
	<target name="module.properties.apply" description="">
 		<!-- Make build timestamp available -->
 		<tstamp>
	 		<format property="configure.timestamp" pattern="yyyyMMddHHmmss" />
 		</tstamp>

		<property file="${toolkit.dir.base}/modules/php/build.properties" />

		<!-- Make all properties available -->
		<tempfile property="all.properties" deleteonexit="true" />
		<echoproperties destfile="${all.properties}" />

		<!-- Fix echoproperties lame escaping -->
		<replace file="${all.properties}" token="\:" value=":" />
		<replace file="${all.properties}" token="\#" value="#" />
		<replace file="${all.properties}" token="\!" value="!" />
		<replace file="${all.properties}" token="\=" value="=" />

		<for list="${properties.dirs}" param="dir">
			<sequential>
				<exec executable="${php.executable}" failonerror="true" dir="${application.dir.base}">
					<arg value="${toolkit.dir.base}/vendor/phpreprocessor/bin/phpreprocessor" />
					<arg value="--command=apply" />
					<arg value="--src=${application.dir.base}/@{dir}" />
					<arg value="--properties=${toolkit.modules.paths.properties},${application.dir.base}/${toolkit.dir.profiles}/common/build.properties,${application.dir.base}/${toolkit.dir.profiles}/${profile}/build.properties,${all.properties}" />
				</exec>
			</sequential>
		</for>
	</target>

	<target name="apply-reverse" description="Replaces values by profile directives names in -dist files">
		<property file="${toolkit.dir.base}/modules/php/build.properties" />
		<for list="${properties.dirs}" param="dir">
			<sequential>
				<exec executable="${php.executable}" failonerror="true" dir="${application.dir.base}">
					<arg value="${toolkit.dir.base}/vendor/phpreprocessor/bin/phpreprocessor" />
					<arg value="--command=apply" />
					<arg value="--reverse=/^.+\.(url|path)\..+$/" />
		         	<arg value="--src=${application.dir.base}/@{dir}" />
		         	<arg value="--properties=${toolkit.modules.paths.properties},${application.dir.base}/${toolkit.dir.profiles}/common/build.properties,${application.dir.base}/${toolkit.dir.profiles}/${profile}/build.properties" />
				</exec>
			</sequential>
		</for>
	</target>

	<!-- Updates common build properties -->
	<target name="module.properties.common.update" description="">
		<!-- Backup existing build.properties file -->
		<copy file="${application.dir.base}/${toolkit.dir.profiles}/${profile}/build.properties" tofile="${application.dir.base}/${toolkit.dir.profiles}/${profile}/build.properties.bak" failonerror="false" />

		<!-- Generate common build.properties file from project sources -->
		<property file="${toolkit.dir.base}/modules/php/build.properties" />
		<for list="${properties.dirs}" param="dir">
			<sequential>
				<exec executable="${php.executable}" dir="${application.dir.base}" output="${application.dir.base}/${toolkit.dir.profiles}/common/build.properties" logError="true" failonerror="true">
					<arg value="${toolkit.dir.base}/vendor/phpreprocessor/bin/phpreprocessor" />
					<arg value="--command=extract" />
					<arg value="--exclude-from=${toolkit.modules.paths.properties}" />
					<arg value="--src=${application.dir.base}/@{dir}" />
					<arg value="--merge-with=${application.dir.base}/${toolkit.dir.profiles}/common/build.properties" />
				</exec>
			</sequential>
		</for>
	</target>

	<!-- Updates profile build properties -->
	<target name="module.properties.profile.update" depends="module.properties.profile.create" description="">
		<!-- Create tree if required -->
		<mkdir dir="${application.dir.base}/${toolkit.dir.profiles}/${profile}" />
		<touch file="${application.dir.base}/${toolkit.dir.profiles}/${profile}/build.properties" />

		<!-- Backup existing build.properties file -->
		<copy file="${application.dir.base}/${toolkit.dir.profiles}/${profile}/build.properties" tofile="${application.dir.base}/${toolkit.dir.profiles}/${profile}/build.properties.bak" failonerror="false" />

		<!-- Generate profile build.properties file from project sources -->
		<property file="${toolkit.dir.base}/modules/php/build.properties" />
		<for list="${properties.dirs}" param="dir">
			<sequential>
				<exec executable="${php.executable}" dir="${application.dir.base}" output="${application.dir.base}/${toolkit.dir.profiles}/${profile}/build.properties" logError="true" failonerror="true">
					<arg value="${toolkit.dir.base}/vendor/phpreprocessor/bin/phpreprocessor" />
					<arg value="--command=extract" />
					<arg value="--exclude-from=${toolkit.modules.paths.properties},${application.dir.base}/${toolkit.dir.profiles}/common/build.properties" />
					<arg value="--src=${application.dir.base}/@{dir}" />
					<arg value="--merge-with=${application.dir.base}/${toolkit.dir.profiles}/${profile}/build.properties" />
				</exec>
			</sequential>
		</for>
	</target>

	<!-- Creates a new property file for configuration profile -->
	<target name="module.properties.profile.create" description="Creates an empty build.properties for the user defined by the TOOLKIT_USER environment variable or the -Dprofile parameter">
		<!-- Create profile directory and property file if it does not exist -->
		<touch file="${basedir}/${toolkit.dir.profiles}/${profile}/build.properties" mkdirs="true" verbose="true" />
	</target>
</project>
